---
globs: apps/gas/**.js
description: スプレッドシート読み出し・JOIN・集約のGAS実装規約
---
# データモデル/シート読み出し（GAS）

参照: [仕様書.md](mdc:仕様書.md)「3. GAS仕様」「コード雛形」, [設計書.md](mdc:設計書.md)「3. データ統合モデル」「4. KPI算出式」

## シート一覧（キー）
- 日次売上集計（`売上日`, `実質売上`, `注文件数`, `出荷商品数`）
- 商品別日次売上集計（`売上日`, `SKU`, `販売数量`, `実質売上`）
- カート取得率日次（`カート取得率%`, `セッション数`）
- 商品別在庫日次集計（`日付`, `SKU`, `在庫数`）
- 全体在庫日次集計（`日付`, `在庫数`）
- 商品マスタ（`SKU`, `ASIN`, `商品名`, `カテゴリ`）
- 商品状態（`SKU`, `在庫健全性`, `推奨発注数`, `需要予測`, `更新日`）

## ユーティリティ（雛形の前提）
- `open_`, `readAll_`, `num_`, `today_`, `cacheGet_/cachePut_`
- `json_` は `_status` を body に埋めて返す（GAS制約のため）
- `guard_` は `?key=APP_TOKEN` の一致を検証（Script Properties）

## JOIN/集約の原則
- SKU を主キーとし、`商品マスタ`/`商品状態` を左外部結合して `asin/name/category` と `inventoryHealth/recommendedOrderQty/demandForecast` を付与。
- `/dashboard` は期間合計（売上/注文件数/出荷商品数）と末日時点在庫、推奨発注・需要予測の総量を返す。
- `/products` は SKU 単位で販売数量・売上を期間集計し、末日時点在庫と JOIN 結果を付与。
- `/product` は SKU でフィルタし、売上/在庫の時系列とヘッダーKPIを返す。
- `/alerts` はルールに合致する SKU を抽出（例: 推奨発注数>0）。

## 列名変更の取り扱い
- 列名が変更された場合は即座に `sheets.js` のマッピングを更新すること。
- 壊れ方が静かで気づきにくいため、最小限の単体チェック（キー列の存在）を先頭で実装推奨。

このルールは GAS 側の実装（`apps/gas/**.js`）に適用されます。

