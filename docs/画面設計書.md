# 画面設計書（最終版）

本書は、**Amazon Seller閲覧特化UI**の**最終画面設計**です。
この設計のみでワイヤー〜実装まで一気通貫で進められる粒度で記述しています。
データは **Googleスプレッドシート（GASで日次更新）** を前提とし、**商品状態シートの「推奨発注数」「需要予測」**を全ページに反映します。

---

## 目次

1. サイトマップ / ルーティング
2. 共通UI（ヘッダー / ナビ / パンくず / 検索 / 期間切替）
3. 画面仕様
   3.1 `/dashboard`（全体ダッシュボード）
   3.2 `/products`（商品一覧）
   3.3 `/products/{sku}`（商品詳細）
   3.4 `/alerts`（アラート/発注提案）
4. データマッピング（UI要素 ↔ シート/列）
5. 指標定義（KPI辞書）
6. 交互作用（粒度切替 / ドリルダウン / ピン留め）
7. 可視化ガイド（色・アイコン・フォーマット）
8. レスポンシブ / アクセシビリティ / ローディング・空・エラー
9. パフォーマンス / ページング / キャッシュの前提
10. 計測（イベントトラッキング） / 受け入れ基準（QA）

---

## 1) サイトマップ / ルーティング

```
/dashboard                  … 全体ダッシュボード（期間・粒度切替）
/products                   … 商品一覧（フィルタ/ソート/ピン）
/products/{sku}             … 商品詳細（時系列・予測・発注判断）
/alerts                     … アラート/発注推奨一覧
```

* **URLクエリ（全ページ共通）**：`?from=YYYY-MM-DD&to=YYYY-MM-DD&grain=day|week|month`
* **遷移原則**：

  * ダッシュボードのランキング / アラート → **1クリック**で `/products/{sku}`
  * パンくず：Dashboard ＞ Products ＞ `{sku}`
* **検索導線**：ヘッダー全域検索（SKU/ASIN/商品名）

---

## 2) 共通UI

### 2.1 ヘッダー（全ページ共通・上部固定）

* **要素**：

  * ロゴ / タイトル
  * 期間選択：日付レンジピッカー（プリセット：7/14/30/90日）
  * 粒度切替：ラジオ `日 / 週 / 月`
  * 検索：SKU / ASIN / 商品名（インクリメンタルサジェスト）
  * ユーザー（アバター）／ログアウト
* **動作**：変更時に**同一クエリパラメータを付けて再取得**（全ページで統一）

### 2.2 ナビゲーション

* **トップナビ**：Dashboard / Products / Alerts
* **パンくず**：Dashboard ＞ Products ＞ `{sku}`（**戻るに依存しない**）

### 2.3 ピン留め

* 商品カード/行の📌で**ローカル保存**（ユーザー別）
* `/dashboard` 上部に「Pinned」セクション（横スクロール）

---

## 3) 画面仕様

### 3.1 `/dashboard`（全体ダッシュボード）

#### レイアウト（縦並び）

1. **KPIカード（2行 × 4枚）**

   * 総売上（税抜）
   * 注文件数
   * 出荷商品数
   * AOV（= 売上/注文件数）
   * **加重平均カート取得率**
   * 現在在庫合計（期間末日）
   * **総推奨発注数**（商品状態.推奨発注数の合計）
   * **総需要予測**（商品状態.需要予測の合計）

   *表示仕様*：

   * 値（フォーマット：金額は `#,###`、率は `0.0%`）
   * サブラベル：比較（前期間同日数 / Δ%）
   * カードクリック：関連ページへ（例：総推奨発注数 → `/alerts?tab=ordering`）

2. **合成トレンドチャート（同期ツールチップ）**

   * X：日付（`grain` に追随）
   * Y1（左）：売上（棒）・販売数量（折れ線）※同軸
   * Y2（右）：**カート取得率**（折れ線）
   * 追加：在庫合計（面/棒）※2軸の重なりを避ける

3. **構成 & ランキング（2カラム）**

   * 左：カテゴリ別売上構成（ドーナツ）
   * 右：ランキングタブ（Top10）

     * 売上上位SKU
     * **推奨発注数上位SKU**（= 優先発注対象）
     * カート率低下SKU（7日移動平均 Δ降順）

4. **アラートダイジェスト**

   * 深刻度順に上位5件
   * 行クリックで `/alerts` フィルタ済み表示

#### インタラクション

* 粒度切替：日/週/月（チャートとランキングが再計算）
* ランキングのSKUクリック → `/{sku}`
* ピン留め（ランキング行の📌）

---

### 3.2 `/products`（商品一覧）

#### フィルタバー（上部）

* カテゴリ（複数選択）
* 在庫健全性（`良 / 注意 / 危険 / 不明`）
* **発注推奨あり（推奨発注数 > 0）**
* **需要 > 在庫**（在庫不足の可能性）
* カート率帯（`<50% / 50-80% / ≥80%`）
* 売上増減（前期比：下落/横ばい/上昇）

> 適用時、テーブルに**フィルタバッジ**表示（×で個別解除）

#### テーブル（デフォルト：50件/ページ・仮想スクロール）

| 列                     | 幅/整列    | 表示/フォーマット                  | ソート         |
| --------------------- | ------- | -------------------------- | ----------- |
| 商品名（サブ：SKU/ASIN/カテゴリ） | 320 / 左 | 主要：商品名、グレー小字：SKU/ASIN/カテゴリ | 可           |
| 売上金額（期間合計）            | 120 / 右 | `¥#,###`                   | 可           |
| 販売数量（期間合計）            | 100 / 右 | 数値                         | 可           |
| **平均カート率（加重）**        | 120 / 右 | `0.0%`＋色バッジ                | 可           |
| **現在在庫数（末日）**         | 110 / 右 | 数値                         | 可           |
| **在庫日数（DOH）**         | 100 / 右 | 小数1桁                       | 可           |
| **推奨発注数**             | 120 / 右 | 数値＋色バッジ                    | **可（降順重要）** |
| **需要予測**              | 120 / 右 | 数値                         | 可           |
| 在庫健全性                 | 110 / 中 | バッジ（良/注意/危険/不明）            | 可           |
| アクション                 | 96 / 中  | 📌 ピン / ↗ 詳細               | -           |

* 行クリック：`/products/{sku}`
* ヘッダー右：**エクスポート（CSV）**／**列表示のカスタム**（表示ON/OFF、順序入替）

---

### 3.3 `/products/{sku}`（商品詳細）

#### ヘッダー

* 左：商品名 / SKU / ASIN / カテゴリ（`商品マスタ`）
* 右：在庫健全性（バッジ）・📌ピン・共有（URLコピー）

#### ミニKPI（横スクロール可）

* 売上（税抜・期間合計）
* 販売数量（期間合計）
* **平均カート率（加重）**
* **現在在庫（末日）**
* **在庫日数（DOH）**
* **推奨発注数（商品状態）**
* **需要予測（商品状態）**

#### チャート群（縦積み）

1. **売上/数量**

   * 売上（棒）＋ 数量（折れ線・同軸）
2. **カート取得率**

   * 折れ線（右軸）
   * グレー帯：`rate < 50%`区間のマスク
3. **在庫推移**

   * 棒 / 面
4. **需要 vs 発注**（重要）

   * 棒：**需要予測**（日/週/月粒度の合計/平均を選択式）
   * 線：**推奨発注数**
   * 補助線：**在庫**（薄線）
   * **網掛け**：`需要予測 > 在庫` の期間

#### 明細テーブル

| 日付 | 販売数量 | 売上金額 | カート率% | 在庫数 | **需要予測** | **推奨発注数** |
| -- | ---: | ---: | ----: | --: | -------: | --------: |

#### インサイト（右カラムカード）

* 例：

  * 「7日MAでカート率 **-12.4pt**」
  * 「**在庫切れ予測：5.2日**（平均日販=xx）」
  * 「**需要 > 在庫** の期間が **8/30日**」
  * 「**提案発注量：** max(推奨発注数, ceil(需要予測×カバレッジ日数 − 現在在庫, 0)) ＝ **xxx**」

---

### 3.4 `/alerts`（アラート/発注提案）

#### タブ

* **Ordering（発注）**：**推奨発注数 > 0**
* Inventory（在庫）：`DOH ≤ 7`（切れ間近）/ `DOH ≥ 90`（過多）
* Performance（パフォーマンス）：カート率急落（7日MA -10pt）
* Sales（売上）：連続売上0（7日）
* State（状態）：在庫健全性が異常（停止/要注意）

#### リスト列

| 深刻度                   | 事象     | SKU / 商品名    | 指標（根拠）                            | 推奨（メモ）   | 更新日        |
| --------------------- | ------ | ------------ | --------------------------------- | -------- | ---------- |
| Critical/Warning/Info | 例：発注必要 | `{sku}` / 名称 | 推奨=xxx / 需要=yyy / 在庫=zzz / DOH=aa | 提案発注量=bb | yyyy-mm-dd |

* ソート：**深刻度** → 指標値
* フィルタ：カテゴリ、深刻度、事象タイプ
* 行クリック：`/products/{sku}` に遷移（期間・粒度は引き継ぎ）

---

## 4) データマッピング（UI要素 ↔ シート/列）

> **キー**：SKU（基本）/ ASIN（カート率のみ）
> **主なシートと列**（実データ準拠）
>
> * **日次売上集計**：`売上日, 注文件数, 出荷商品数, 実質売上`
> * **商品別日次売上集計**：`SKU, 売上日, 販売数量, 実質売上`
> * **カート取得率日次**：`ASIN, スナップショット日付, カート取得率%, セッション数`
> * **商品別カート取得率集計**（週/月の指標用）
> * **商品別在庫日次集計**：`SKU, 日付, 在庫数`
> * **全体在庫日次集計**：`日付, 在庫数`
> * **商品マスタ**：`SKU, ASIN, 商品名, カテゴリ`
> * **商品状態**：`SKU, 在庫健全性, 推奨発注数, 需要予測, 更新日`

### 4.1 ダッシュボード

* KPI

  * 総売上/注文件数/出荷商品数/AOV：**日次売上集計**（期間合計）
  * 加重平均カート率：**カート取得率日次**（`∑率×セッション / ∑セッション`）
  * 在庫合計：**全体在庫日次集計**（期間末日）
  * **総推奨発注数 / 総需要予測**：**商品状態**（全SKU合計）
* グラフ

  * 売上/数量：**日次売上集計**
  * カート率：**カート取得率日次**
  * 在庫：**全体在庫日次集計**
* ランキング

  * 売上Top：**商品別日次売上集計**（SKUで集計）
  * **推奨Top**：**商品状態.推奨発注数** 降順
  * 低下：**カート取得率日次**の7日MA差分

### 4.2 商品一覧

* 基本属性：**商品マスタ**（SKU, ASIN, 商品名, カテゴリ）
* 売上・数量：**商品別日次売上集計**（期間合計）
* **平均カート率（加重）**：**カート取得率日次**（ASIN→SKUに連携）
* **現在在庫（末日）/ DOH**：**商品別在庫日次集計** + 平均日販（売上数量の期間平均）
* **推奨発注数 / 需要予測 / 在庫健全性**：**商品状態**

### 4.3 商品詳細

* 同上をSKU単位で日別に取得・表示
* **需要 vs 発注**：**商品状態**の値を優先、日/週/月表示は補間（週=合計, 月=合計/平均は設定で選択）

### 4.4 アラート

* 発注必要：**商品状態.推奨発注数 > 0**
* 在庫切れ予測：`DOH = 在庫末日 / 平均日販` ≤ 7
* 需要超過警戒：`需要予測 ≥ 在庫末日 + 7日平均日販×k（初期1.0）`
* カート率急落：**カート取得率日次** 7日MAの下降幅 ≥ 10pt
* 連続売上0：**商品別日次売上集計**で連続7日 `販売数量=0`
* 在庫過多：DOH ≥ 90
* 状態異常：**商品状態.在庫健全性** ∈ {停止, 要注意}

---

## 5) 指標定義（KPI辞書）

* **総売上（税抜）**：`∑ 実質売上`（日次売上集計 / 商品別日次売上集計の合計）
* **注文件数**：`∑ 注文件数`（日次売上集計）
* **出荷商品数**：`∑ 出荷商品数`（日次売上集計）
* **AOV**：`総売上 / 注文件数`
* **平均日販（SKU）**：`∑ 販売数量 / 期間日数`
* **DOH（在庫日数）**：`在庫末日 / 平均日販`
* **加重平均カート率**：`∑(率×セッション)/∑セッション`（ASIN→SKU連携後）
* **推奨発注数 / 需要予測**：**商品状態**の値（空なら推定可：`過去30日平均×季節係数=1.0` など）
* **提案発注量**（詳細ページ表示）：
  `max(推奨発注数, ceil(需要予測 × カバレッジ日数 − 現在在庫, 0))`

---

## 6) 交互作用

* **期間切替・粒度切替**：ヘッダー操作で全ページ同期（クエリ共有）
* **ドリルダウン**：ランキング/アラート行クリック → `/products/{sku}`
* **ピン留め**：商品一覧・詳細の📌でローカル保存（Dashboardに反映）
* **テーブル操作**：列表示切替、順序入替、寄せ（昇順/降順トグル）

---

## 7) 可視化ガイド

### 7.1 色分け（初期閾値）

* **良（Good）**：緑 `#10B981`
* **注意（Fair）**：橙 `#F59E0B`
* **悪（Poor）**：赤 `#EF4444`
* **情報（Info）**：青 `#3B82F6`
* **不明**：灰 `#9CA3AF`

**適用例**

* カート率：`≥80% 緑 / 50–79% 橙 / <50% 赤`
* DOH：`≥60 緑 / 15–59 橙 / <15 赤`
* 推奨発注数：`=0 灰 / 1–30 青 / 31–100 濃青 / >100 紫（#8B5CF6）`

### 7.2 アイコン

* 売上：💴 ／ 在庫：📦 ／ カート率：🛒 ／ アラート：🚨 ／ 発注：📝 ／ ピン：📌

### 7.3 フォーマット

* 金額：`¥#,###`（小数なし）
* 数量：整数
* 率：`0.0%`
* 日付：`YYYY-MM-DD`

---

## 8) レスポンシブ / A11y / 状態表示

### 8.1 レスポンシブ

* **≥1280px**：2カラム（ランキング+構成の並置、詳細のサイドインサイト）
* **<1280px**：1カラム（セクション縦積み、テーブルは横スクロール）

### 8.2 アクセシビリティ

* 色＋テキスト指標（色覚多様性対応）
* KPIカードに `aria-label`（定義と単位を含む）
* ローディング：`aria-busy`、`aria-live="polite"`
* チャート：ツールチップ＋凡例に系列名・単位

### 8.3 状態表示

* **ローディング**：スケルトン（KPIカード/テーブル/チャート）
* **空**：アイコン＋説明＋「期間を変える / フィルタ解除」ボタン
* **エラー**：再試行ボタン、発生源（API/ネットワーク）表示

---

## 9) パフォーマンス / ページング / キャッシュ

* テーブル：**仮想スクロール** + サーバページング（初期 50件、続き取得）
* 検索：入力300msデバウンス
* チャート：最大1,000ポイント/系列、超過時はサンプリング
* キャッシュ：GAS側短期（~2分） / フロント ISR（例：30分）＋ SWR（60秒）

---

## 10) 計測 / 受け入れ基準

### 10.1 イベント

* `view_dashboard`, `view_products`, `view_product_detail`, `view_alerts`
* `click_rank_item`（sku, rank_type）
* `toggle_grain`（grain） / `change_date_range`
* `pin_sku` / `unpin_sku`
* `export_products_csv`
* `open_alert_item`（type, severity）

### 10.2 受け入れ基準（抜粋）

* すべてのページで**期間・粒度切替が同期**して反映される
* **推奨発注数 / 需要予測**が**Dashboard/一覧/詳細/Alerts**全てで表示・活用される
* `/products` で **推奨発注数**の**降順ソート**が可能
* `/products/{sku}` に **需要 vs 発注** チャートがあり、`需要>在庫`期間が視覚化される
* `/alerts` の **Ordering** タブに **推奨発注>0** のSKUが表示される
* 空・ローディング・エラーの状態設計に従って表示される

---

### 付録：ページごとの部品ID（data-testid 例）

* Dashboard：`kpi-revenue`, `kpi-buybox`, `chart-combo`, `rank-top-reco`, `alert-digest`
* Products：`filter-category`, `filter-reco`, `table-products`, `col-reco`, `col-forecast`
* ProductDetail：`kpi-reco`, `kpi-forecast`, `chart-forecast-vs-order`, `insight-cards`
* Alerts：`tab-ordering`, `list-alerts`, `severity-chip`

---

これが**最終画面設計書**です。
本設計に従い、ワイヤーフレーム（Figma）→ 実装（Next + GAS）→ 受け入れ（QA）まで一貫して進められます。必要であれば、**各ページのFigma用レイアウトグリッド**や**チャート設定（Rechartsオプション例）**も追記します。
