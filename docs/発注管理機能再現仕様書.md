## Suprole-befree 発注管理システム 仕様書・設計書（完全再現版）

最終更新: 2025-11-02

本書は、当リポジトリ内の実装を完全に再現できる粒度で記述した仕様・設計ドキュメントです。Google Apps Script（以下、GAS）Web アプリとして、スプレッドシートをデータストアに用い、発注管理（作成・一覧・編集・ステータス遷移・通知メール）を行います。

---

## 1. システム概要

- **目的**: Suprole と befree 間の発注・納品に関する管理を、スプレッドシートを基盤に Web UI で効率化する。
- **主要機能**:
  - 認証（共通パスワード方式）
  - 発注一覧（検索・絞り込み・ソート・ページネーション・行選択）
  - 行内/モーダル編集（消費税率、伝票No.、到着予定日）
  - ステータス遷移（定義済みの許可関係）
  - 依頼メール/納品手続完了メールの送信（選択行対象）
  - 新規発注作成（商品検索→選択→数量・計算→確認→作成）
  - マスタ閲覧（商品マスタ×仕入れマスタの結合ビュー）

---

## 2. 用語・主体

- **発注**: 本システムで管理する 1 明細のこと（`po_id` 単位）
- **Suprole / befree**: 関係会社。通知メールの送受信先として使用
- **商品マスタ**: `ASIN` をキーとする商品属性（商品名、ブランド等）
- **仕入れマスタ**: `ASIN` をキーとする仕入れ属性（セット個数、最小ロット、仕入れ値、危険物、消費期限要）

---

## 3. 全体アーキテクチャ

- **プラットフォーム**: Google Apps Script（ランタイム: V8）
- **UI**: HtmlService（`app.html` + `client-js.html` + `styles.html`）
- **データストア**: Google スプレッドシート（Apps Script ID で参照）
- **メール**: `MailApp.sendEmail` を使用
- **公開設定**: `appsscript.json` の `webapp` 設定に基づく（`access: DOMAIN`, `executeAs: USER_DEPLOYING`）
- **OAuth スコープ**:
  - `https://www.googleapis.com/auth/spreadsheets`
  - `https://www.googleapis.com/auth/script.send_mail`

---

## 4. 環境設定（CONFIG）

`gas/src/server/config.gs` に定義。

- `MAIL.SUPROLE`: Suprole 宛メールアドレス
- `MAIL.BEFREE`: befree 宛メールアドレス
- `AUTH.COMMON_PASSWORD`: 共通パスワード（平文管理）
- `SPREADSHEET_ID`: データ保存スプレッドシート ID
- `SHEETS`:
  - `ORDERS`: 発注シート名（例: `発注_ops`）
  - `PRODUCT_MASTER`: 商品マスタシート名（例: `商品_master`）
  - `PURCHASE_MASTER`: 仕入れマスタシート名（例: `仕入れ_master`）
- `PAGINATION.ITEMS_PER_PAGE`: 1 ページ当たり件数（既定 50。UI 側でも 50 を使用）

その他:
- `appsscript.json`:
  - `timeZone: Asia/Tokyo`
  - `exceptionLogging: STACKDRIVER`
  - `webapp.access: DOMAIN`
  - `webapp.executeAs: USER_DEPLOYING`

---

## 5. データモデル / スプレッドシート構成

### 5.1 シート一覧

- `ORDERS`（例: `発注_ops`）: 発注明細
- `PRODUCT_MASTER`（例: `商品_master`）: 商品属性
- `PURCHASE_MASTER`（例: `仕入れ_master`）: 仕入れ属性

### 5.2 ORDERS シート（発注）

必須/想定カラム（実装で参照されるキー。順序は先頭列が `po_id` 想定）:

- `po_id`（文字列）: 発注 ID。形式 `PO-YYYYMMDD-NNNN`（当日連番、重複不可）
- `ASIN`（文字列）
- `商品コード`（文字列）
- `発注日`（日付）
- `発注先セラー`（文字列。既定 `Suprole`）
- `発注数量`（数値: 個数）
- `単価`（数値: 税抜単価/個）
- `税抜純売上高`（数値: `発注数量 × 単価`）
- `消費税率`（数値: 小数。例 0.1 は 10%）
- `伝票No.`（文字列）
- `Suprole到着日`（日付: 到着予定）
- `ステータス`（文字列）
- `created_by`（文字列）
- `created_at`（日付）
- `last_updated_by`（文字列）
- `last_updated_at`（日付）

制約:
- `po_id` は一意。`generatePoId()` が当日最大連番+1で生成し、重複チェックを行う。
- `発注日` 等の日付は GAS 側では `Date`、クライアント表示時は `YYYY-MM-DD`。

### 5.3 PRODUCT_MASTER シート（商品マスタ）

- `ASIN`（文字列、キー）
- `product_code`（文字列）
- `title`（文字列: 商品名）
- `brand`（文字列）

### 5.4 PURCHASE_MASTER シート（仕入れマスタ）

- `ASIN`（文字列、キー）
- `セット個数`（数値）
- `最小ロット`（数値: セット単位）
- `仕入れ値`（数値: セット価格）
- `危険物`（真偽）
- `消費期限要`（真偽）

---

## 6. サーバ機能（API）

以下はクライアントから `google.script.run` で呼ばれる公開関数。

### 6.1 認証
- `authenticateUser(username: string, password: string)` → `{ success: boolean, message?: string, username?: string }`
  - `password` が `CONFIG.AUTH.COMMON_PASSWORD` と一致した場合のみ成功。
  - 成功時、クライアントは `sessionStorage` に `{ username }` を保存。

### 6.2 発注取得/詳細
- `getOrders(filters: object|null)` → `OrderRow[]`
  - `filters` が `null` なら全件。商品マスタと JOIN し `商品名`/`ブランド` を付与。
  - `Date` は ISO 文字列へ変換して返却。
  - フィルタ条件: `po_id`, `statuses`, `asin`, `productName`（部分一致）, `seller`, `fromDate`, `toDate`（`発注日` に対する期間）。
- `getOrderById(poId: string)` → `OrderRow|null`

### 6.3 発注作成/更新
- `createOrderFromClient(input)` → `{ success: true, po_id: string }`
  - 必須: `asin`, `productCode`（未指定時は商品マスタから補完）, `setSize`, `purchasePrice`, `setCount`, `seller('Suprole')`, `createdBy`。
  - 検証: `ASIN` 必須、`productCode` 補完後未取得はエラー、`setSize/setCount/purchasePrice > 0` 必須。
  - 計算: `unitPrice = round(purchasePrice / setSize)`, `quantityUnits = setCount * setSize`, `amount = unitPrice * quantityUnits`。
  - 生成: `po_id = generatePoId()`、`ステータス = 'sup_依頼中'`、監査項目（作成/更新者・日時）付与。
- `updateOrder(poId: string, updates: object)` → `true`
  - `消費税率`（%→小数にして保持）、`伝票No.`, `Suprole到着日`（`YYYY-MM-DD` 文字列を `Date` 化）など任意項目を更新。
  - 常に `last_updated_at = new Date()`, `last_updated_by` は payload で上書き。

### 6.4 ステータス遷移
- `changeOrderStatus(poId: string, newStatus: string, username?: string)` → `{ success: true }`
  - 現在値から `STATUS_TRANSITIONS` に定義された集合へ遷移可能な場合のみ許可。
  - 成功時 `ステータス` を更新し、監査項目更新。

許可遷移（抜粋）:
```
sup_依頼中 → be_メーカー取寄中 | 保留 | 返品
be_メーカー取寄中 → be_納品手続完了 | 保留 | 返品
be_納品手続完了 → sup_受取完了 | 保留 | 返品
sup_受取完了 → sup_fba出荷完了 | 保留 | 返品
sup_fba出荷完了 → 保留 | 返品
保留 → 保留 | 返品
返品 →（遷移なし）
```

### 6.5 マスタ検索・ビュー
- `searchProducts({ asin?, productCode?, namePart? })` → `{ ASIN, product_code, title, setSize, minLot, purchasePrice }[]`
  - 商品マスタに仕入れマスタを JOIN。完全一致/部分一致で絞り込み。
- `getMasterView({ asin?, productCode?, namePart?, brand? })` → 結合済み一覧
  - 返却: `ASIN, product_code, title, brand, setSize, purchasePrice, minLot, hazard, hasExpiry`

### 6.6 通知メール
- `sendRequestEmail(poIds: string[])` → `{ success: true, sentCount: number }`
  - 対象は `ステータス = 'sup_依頼中'` の行のみ。
  - 宛先: `CONFIG.MAIL.BEFREE`
  - 件名: `【発注依頼】Suprole - YYYY年MM月DD日 (N件)`
- `sendDeliveryCompleteEmail(poIds: string[])` → `{ success: true, sentCount: number }`
  - 対象は `ステータス = 'be_納品手続完了'` の行のみ。
  - 宛先: `CONFIG.MAIL.SUPROLE`
  - 件名: `【納品手続完了】befree - YYYY年MM月DD日 (N件)`

本文はいずれも HTML テーブルで以下列を含む（実装準拠）:
- 発注ID, ASIN, 商品コード, 商品名, 数量, 単価（¥書式）, 合計額（¥書式）, 発注日（依頼メール）
- 追加: 消費税率（%表示）, 伝票No., 到着予定日（納品メール）
※ 合計件数・合計数量・合計金額（税抜）・税額・税込合計（納品メール）を本文末尾に表示。

---

## 7. UI 仕様

### 7.1 画面遷移
- `login`（初期） → ログイン成功で `orders`
- `orders`（発注一覧）
- `create`（新規発注）
- `master`（マスタ閲覧）

### 7.2 共通
- ヘッダー: タイトル、ログインユーザー表示、ログアウトボタン
- ナビ: `発注一覧` / `新規作成` / `マスタ閲覧`
- トースト通知: 右下表示、`success/error/info`
- グローバルローディング: 背景半透過 + スピナー

### 7.3 ログイン
- 入力: ユーザー名、パスワード
- 認証成功: `sessionStorage.user = { username }` を保存し `orders` へ
- 失敗: エラーメッセージ表示

### 7.4 発注一覧（orders）
- ダッシュボード: 件数、合計個数、合計金額（税抜）
- フィルタ（コンパクト）:
  - 発注日（開始/終了）
  - ステータス（選択）
  - 発注先セラー（固定: Suprole）
  - ASIN（完全一致）
  - 商品名（部分一致）
- テーブル列: 発注日, ASIN, 商品コード, 商品名（省略表示）, 発注数量（個）, 単価, 税抜純売上高, 消費税率(%), 伝票No., 到着予定日, ステータス（セレクト）, 編集, 最終更新者
- 操作:
  - 並び替え: 発注日/数量/税抜純売上高
  - 行選択: チェックボックス、ページ一括選択
  - ステータス変更: 許可遷移のみ。確認ダイアログ表示。
  - 編集: モーダル（税率[%], 伝票No., 到着予定日[date]）で更新
  - メール送信: 選択行に対して「依頼メール」「納品完了通知」
  - ページネーション: 1 ページ 50 件（固定）

### 7.5 新規発注（create）
フロー:
1) 商品検索（ASIN/商品コード 完全一致、商品名 部分一致）
2) 一覧から選択
3) 数量入力（セット数）
   - 検証: 最小ロット倍数チェック
   - 計算: 発注数量（個）/単価/税抜金額を即時計算表示
4) 確認ダイアログ → 実行でサーバ作成 API 呼び出し

### 7.6 マスタ閲覧（master）
- 検索: ASIN/商品コード 完全一致、商品名 部分一致、ブランド 完全一致
- 列: ASIN, 商品コード, 商品名, ブランド, セット個数, 仕入れ値, 最小ロット, 危険物, 消費期限要
- 並び替え: 一部列で昇降順切替

---

## 8. バリデーション/計算仕様

- 新規作成:
  - `productCode` 未入力時は商品マスタから `ASIN` 一致で補完。未取得ならエラー。
  - `setSize > 0`, `setCount > 0`, `purchasePrice > 0` を強制。
  - 最小ロット（仕入れマスタ `最小ロット`）がある場合、`setCount % minLot == 0` を強制。
  - `unitPrice = round(purchasePrice / setSize)`、`quantityUnits = setCount * setSize`、`amount = unitPrice * quantityUnits`。

- 編集:
  - `消費税率` は 0〜100[%] を入力、保存時に小数へ変換（例: 10 → 0.1）。
  - `Suprole到着日` は `YYYY-MM-DD` をサーバで `Date` 化。

- 一覧表示:
  - 単価/金額は `¥` + 3 桁区切り。
  - 日付は `YYYY-MM-DD`。

---

## 9. メール仕様（詳細）

### 9.1 依頼メール（befree 宛）
- 宛先: `CONFIG.MAIL.BEFREE`
- 件名: `【発注依頼】Suprole - YYYY年MM月DD日 (N件)`
- 対象: `ステータス = 'sup_依頼中'`
- 本文: HTML テーブルで以下列を表示
  - 発注ID, ASIN, 商品コード, 商品名, 数量（個）, 単価（¥）, 合計額（¥）, 発注日
- 集計: 発注件数、合計発注数、合計発注額（税抜）

### 9.2 納品手続完了メール（Suprole 宛）
- 宛先: `CONFIG.MAIL.SUPROLE`
- 件名: `【納品手続完了】befree - YYYY年MM月DD日 (N件)`
- 対象: `ステータス = 'be_納品手続完了'`
- 本文: HTML テーブルで以下列を表示
  - 発注ID, ASIN, 商品コード, 商品名, 数量（個）, 単価（¥）, 合計額（¥）, 消費税率（%）, 伝票No., 到着予定日
- 集計: 発注件数、合計数、税抜合計、消費税、税込合計

---

## 10. エラー/例外メッセージ（主なもの）

- 認証: `ユーザー名を入力してください`／`パスワードが正しくありません`
- メール送信: `送信対象が選択されていません`／`対象ステータス（...）がありません`／`対象レコードが取得できませんでした`
- ステータス変更: `パラメータ不正`／`対象レコードなし: <po_id>`／`ステータス遷移エラー: <現> → <新>`
- 発注作成: `入力が空です`／`ASINが不正です`／`商品コードが取得できません（商品マスタを確認してください）`／`セット個数が不正です`／`セット数が不正です`／`仕入れ値が不正です`
- 共通: `SPREADSHEET_ID を設定してください`／`シート未存在: <name>`／`ヘッダー未定義: <name>`

---

## 11. 権限・セキュリティ

- Web アプリ公開: `DOMAIN` 限定、実行ユーザー: デプロイユーザー
- 認証: 共通パスワード方式（`config.gs` に平文）。ユーザー名は任意入力しクライアントにのみ保存。
- セッション管理: ブラウザ `sessionStorage` のみ（サーバセッションなし）
- データアクセス: GAS スクリプトからシート直接操作
- ロギング: `Logger` と Stackdriver 例外ログ

注: 本仕様は実装の完全再現を目的としており、安全性強化（独自ユーザー/ロール、強固な認可、秘密情報の暗号化等）は別途検討事項。

---

## 12. デプロイ/運用手順

1) Google Apps Script プロジェクトとして `gas/src` 一式をアップロード
2) `config.gs` の値を環境に合わせて設定
   - `SPREADSHEET_ID`（対象スプレッドシートの ID）
   - `SHEETS` 名（実シート名と合わせる）
   - `MAIL` 宛先、`AUTH.COMMON_PASSWORD`
3) スプレッドシートに 3 シート作成
   - `発注_ops`: 5.2 のカラムをヘッダー行に定義
   - `商品_master`: 5.3 のカラムをヘッダー行に定義
   - `仕入れ_master`: 5.4 のカラムをヘッダー行に定義
4) スクリプトの `appsscript.json` に記載のスコープを確認
5) 公開 → ウェブアプリとして導入
   - アクセス: ドメイン内
   - 実行者: デプロイするユーザー
6) 初回実行で権限承認

---

## 13. 既知の制約/補足

- 認証が共通パスワードのため、個別ユーザー権限の分離はなし
- `itemsPerPage` は UI 側で 50 固定。`CONFIG.PAGINATION` と重複定義
- ステータス遷移以外のルール（返品後復帰など）は未定義
- 商品名は注文取得時に商品マスタで補完されるため、マスタ未整備だと空文字になる

---

## 14. 再現チェックリスト

- [ ] `SPREADSHEET_ID` が設定されている
- [ ] シート名が `config.gs` と一致
- [ ] ORDERS シートのヘッダーが 5.2 に一致
- [ ] 商品/仕入れマスタが 5.3/5.4 に一致
- [ ] GAS Web アプリが `DOMAIN` 公開・`USER_DEPLOYING` 実行
- [ ] 認証パスワードが合致しログイン可能
- [ ] 発注一覧が表示・検索・ソート・ページング可能
- [ ] ステータス変更が許可遷移のみ動作
- [ ] 編集（税率/伝票No./到着予定）が保存される
- [ ] メール送信が対象ステータスのみ送信可能
- [ ] 新規作成が最小ロット検証/計算含め正常
- [ ] マスタ閲覧が検索/ソート表示できる

---

## 付録 A: 主要ファイル構成

- サーバ
  - `gas/src/server/main.gs`: `doGet`, `include`
  - `gas/src/server/config.gs`: 環境設定
  - `gas/src/server/auth.gs`: 認証
  - `gas/src/server/orders.gs`: 発注取得/作成/更新/ステータス/po_id 生成
  - `gas/src/server/products.gs`: マスタ検索/ビュー
  - `gas/src/server/mail.gs`: メール送信・本文生成
  - `gas/src/shared/sheets.gs`: シートユーティリティ
- クライアント
  - `gas/src/app.html`: ルート HTML
  - `gas/src/client-js.html`: 画面レンダリング/イベント/データ操作
  - `gas/src/styles.html`: スタイル
  - `gas/src/appsscript.json`: 設定

---

本書の内容は、当該リポジトリのコード（GAS/HTML/CSS/JS）に厳密に一致するよう作成しています。ここに記載されたカラム・API・画面・検証・遷移・メール仕様を満たせば、同等のシステムを構築できます。


